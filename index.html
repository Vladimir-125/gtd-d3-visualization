<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Global Terrorism Database visualization">
  <meta name="author" content="">

  <title>Global Terrorism Database visualization</title>

  <!-- Leaflet map -->
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-lasso@2.2.3/dist/leaflet-lasso.umd.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
  
  <!-- Highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/data.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/t/bs-3.3.6/jqc-1.12.0,dt-1.10.11/datatables.min.css"/>
  <link href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">
  <script src='https://code.jquery.com/jquery-3.5.1.js'></script>
  <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
  <script src='https://cdn.datatables.net/buttons/1.6.5/js/buttons.colVis.min.js'></script>
  <!-- D3 -->
  <script src="https://d3js.org/d3.v6.min.js"></script>
  

  <!-- Custom styles for this template -->
  <link href="css/simple-sidebar.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="bg-light border-right" id="sidebar-wrapper">
      <div class="sidebar-heading">Global Terrorism</div>
      <div class="list-group list-group-flush">
        <a href="#" class="list-group-item list-group-item-action bg-light">Dashboard</a>
        <a href="#" class="list-group-item list-group-item-action bg-light">Overview</a>
        <a href="#" class="list-group-item list-group-item-action bg-light">Events</a>
      </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <button class="btn btn-primary" id="menu-toggle">Menu</button>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Dropdown
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="#">Action</a>
                <a class="dropdown-item" href="#">Another action</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#">Something else here</a>
              </div>
            </li>
          </ul>
        </div>
      </nav>

      <div class="container-fluid">
          <div class="row">
              <div class="col-xs-12 col-md-6">
                  <div class="container-fluid">
                      <div class="row">
                           <div id='map'></div>
                      </div>
                      <div class="row">
                        <figure class="highcharts-figure">
                            <div id="container"></div>
                          </figure>
                      </div>
                  </div>
              </div>
              <div class="col-xs-12 col-md-6">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <table id="gtd-table" class="table table-striped table-bordered" width="100%" style="table-layout:fixed;">
                                <thead>
                                    <tr id="header-row"></tr>
                                </thead>
                            </table>
                        </div>
                        
                    </div>
                    <div class="row">

                    </div>
                </div>
              </div>
          </div>
        <div id="loader-wrapper">
          <div id=loader>
            <div id="spinner"></div>
            <div id="loader-info">
              <h3>Data is loading </br>Please wait...</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap core JavaScript -->
  <!-- <script src="vendor/jquery/jquery.min.js"></script> -->
  <!-- <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script> -->

  <!-- Menu Toggle Script -->
  <script>
    $("#menu-toggle").click(function(e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
    });
  </script>

<script>
        
  let data;
  let json_data;
  let ctrlDown = false;
    const ctrlKey = 17,
        cmdKey = 91;
  const map = L.map('map').setView([0, 0], 2);
  const clusterGroupOptions = {
              iconCreateFunction: function(cluster) {
                  return L.divIcon(clusterStyler(cluster.getChildCount()));
              }
          };
  let markers = L.markerClusterGroup(clusterGroupOptions);

  $( document ).ready(async ()=> {
    // load map data  
    const res = await fetch('/data')
      data = await res.json()
      // load table data
      const res2 = await fetch('/table-data')
      json_data = await res2.json()
      for(let i=0; i < json_data.length; i++){
            let eventid = json_data[i]['eventid'];
            json_data[i]['year'] = eventid.slice(0, 4);
            json_data[i]['month'] = eventid.slice(4, 6);
            json_data[i]['day'] = eventid.slice(6, 8);
            json_data[i]['idx'] = eventid.slice(8, 12);
        }
    //   drawSlider()
      drawMap(data)
    //   initTable()
    $(document).keydown(function(e) {
        if (e.keyCode == ctrlKey || e.keyCode == cmdKey) ctrlDown = true;
    }).keyup(function(e) {
        if (e.keyCode == ctrlKey || e.keyCode == cmdKey) ctrlDown = false;
    });
    // $(document).keydown(function(e) {
    //     if (ctrlDown) console.log("Document catch Ctrl");
        
    // }); 
  });
  function clusterStyler(elements){
      if(elements > 10000){
          return { html: '<span class="l4"><b >' + elements + '</b></span>' }
      }else if(elements > 1000){
          return { html: '<span class="l3"><b >' + elements + '</b></span>' }
      }else if(elements > 100){
          return { html: '<span class="l2"><b >' + elements + '</b></span>' }
      }else{
          return { html: '<span class="l1"><b >' + elements + '</b></span>' }
      }
  }
  
  function drawMap(data){
      try {
          const lassoControl = L.control.lasso().addTo(map);
          const mapLink =
          '<a href="http://openstreetmap.org">OpenStreetMap</a>';
          L.tileLayer(
          'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; ' + mapLink + ' Contributors',
              maxZoom: 10,
              minZoom: 2
          }).addTo(map);
          
          for (var i = 0; i < data.length; i++) {
              const marker = new L.marker([data[i].latitude, data[i].longitude])
                  .bindPopup(data[i].eventid)
              markers.addLayer(marker);
          }
          map.addLayer(markers);
  
          function resetSelectedState() {
              map.eachLayer(layer => {
                  if (layer instanceof L.Marker) {
                  } else if (layer instanceof L.Path) {
                      layer.setStyle({ color: '#3388ff' });
                  }
              });

          }

          function setSelectedLayers(layers) {
              resetSelectedState();
              layers.forEach(layer => {
                  if (layer instanceof L.Marker) {
                      layer.setIcon(new L.Icon.Default({ className: 'selected '}));
                  } else if (layer instanceof L.Path) {
                      layer.setStyle({ color: '#ff4620' });
                  }
              });
              const events = layers.map(e=>e._popup._content)
              drawTable(events)
          }

          map.on('mousedown', () => {
              resetSelectedState();
          });
        //   map.on('mouseup', event => {
        //       setSelectedLayers(event.layers);
        //   });
          map.on('lasso.finished', event => {
              setSelectedLayers(event.layers);
          });

          map.on('lasso.enabled', () => {
              resetSelectedState();
          });
          document.getElementById('loader-wrapper').style.display = 'none';
      }catch{
          console.log('Some error occured!')
      }
  }
  
  function getMonth(month) {
      let d = new Date().toString().split(" ")
      d[1] = month
      d = new Date(d.join(' ')).getMonth()+1
      if(!isNaN(d)) {
          if(d<10){
              return '0'+d
          }else{
              return d
          }
      }
      return -1;
  }

  // date type to YYYYMMDD
  function dateFilter(min, max){
      try{
          let mintxt = new Date(min);
          let minyear = mintxt.toString().split(" ")[3];
          let minmonth = getMonth(mintxt.toString().split(" ")[1]);
          let minday = mintxt.toString().split(" ")[2];
          let mindate = minyear+minmonth+minday;
          let maxtxt = new Date(max);
          let maxyear = maxtxt.toString().split(" ")[3];
          let maxmonth = getMonth(maxtxt.toString().split(" ")[1]);
          let maxday = maxtxt.toString().split(" ")[2];
          let maxdate = maxyear+maxmonth+maxday;
          let output = mindate+"_"+maxdate;
          return output;
      }catch{
          console.log('Some error occured!');
      }
  }

  function dataExtracter(mindate, maxdate, data){
      let rangedData = data;
      let filteredData = new Array();
      try{
        rangedData.forEach(function(item){
            let ymd = item.eventid.slice(0,8);
            if ((parseInt(ymd)>=parseInt(mindate))&&(parseInt(ymd)<=parseInt(maxdate))){
                filteredData.push(item);
            }
        })
      }catch{
          console.log('Some error occured!')
      }
      return filteredData
  }

  async function drawSlider(){
      try {
          const res = await fetch('/time')
          const time = await res.json()
          drawTime(time)
      }catch{
          console.log('Some error occured!')
      }
  }     

  function drawTime(time) {
      Highcharts.chart('container', {
      chart: {
          events: {
              selection: function(event) {
                  if(event.xAxis != null){
                      let output = dateFilter(event.xAxis[0].min,event.xAxis[0].max);
                      let startingDate = output.split("_")[0]
                      let endingDate = output.split("_")[1]
                      // items : selected cases occured between startingdate ~ endingdate
                      let items = dataExtracter(startingDate, endingDate, data)
                      map.removeLayer(markers);
                      markers = L.markerClusterGroup(clusterGroupOptions);
                      for (var i = 0; i < items.length; i++) {
                      const marker = new L.marker([items[i].latitude, items[i].longitude])
                          .bindPopup(items[i].eventid)
                      markers.addLayer(marker);
                      }
                      map.addLayer(markers)
                  }
                  else{
                      map.removeLayer(markers);
                      markers = L.markerClusterGroup(clusterGroupOptions);
                      for (var i = 0; i < data.length; i++) {
                      const marker = new L.marker([data[i].latitude, data[i].longitude])
                          .bindPopup(data[i].eventid)
                      markers.addLayer(marker);
                      }
                      map.addLayer(markers)
                      console.log("selection: reset");
                  }
              }
          },
          zoomType: 'x'
      },
      title: {
          text: 'Time-Series Slider'
      },
      subtitle: {
          text: document.ontouchstart === undefined ?
          'Click and drag in the plot area to zoom in.' : 'Pinch the chart to zoom in.'
      },
      xAxis: {
          type: 'datetime'
      },
      yAxis: {
          title: {
          text: 'Number of Terror Cases'
          }
      },
      legend: {
          enabled: false
      },
      plotOptions: {
          area: {
          fillColor: {
              linearGradient: {
              x1: 0,
              y1: 0,
              x2: 0,
              y2: 1
              },
              stops: [
              [0, Highcharts.getOptions().colors[0]],
              [1, Highcharts.color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
              ]
          },
          marker: {
              radius: 2
          },
          lineWidth: 1,
          states: {
              hover: {
              lineWidth: 1
              }
          },
          threshold: null
          }
      },

      series: [{
          type: 'area',
          name: '# of cases',
          data: time
      }]
      });
  }

</script>

<script>
    // table
    // Some routines
    // Should read from data.
    const total_keys = ['eventid', 'year', 'month', 'day', 'idx', 'extended', 'region_txt', 'country_txt', 'city', 'provstate', 'latitude', 'longitude', 'summary', 'multiple', 'success', 'suicide', 'attacktype1_txt', 'targtype1_txt', 'targsubtype1_txt', 'gname', 'motive', 'weaptype1_txt', 'weapsubtype1_txt', 'weapdetail', 'nkill', 'nwound', 'dbsource', 'ishostkid', 'ransom'];

    // Text to display for each key
    let rename_keys = d3.scaleOrdinal()
                        .domain(total_keys)
                        .range(['event', 'Year', 'Month', 'Day', 'Idx', 'extended', 'region', 'country', 'city', 'provstate', 'latitude', 'longitude', 'summary', 'multiple', 'success', 'suicide', 'attack type', 'target type', 'targsubtype', 'gname', 'motive', 'weapon type', 'weapon subtype', 'weapon detail', 'kill', 'wound', 'dbsource', 'ishostkid', 'ransom']);

    // Column width of each key
    // let column_widths = d3.scaleOrdinal()
    //                     .domain(total_keys)
    //                     .range([50, 10, 10, 10, 10, 10, 50, 50, 50, 50, 50, 50, 100, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50]);
    const column_widths = [50, 10, 10, 10, 10, 10, 50, 50, 50, 50, 50, 50, 200, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50];
    // Summary of each key                    
    let summary_keys = d3.scaleOrdinal()
                        .domain(total_keys)
                        .range(['YYYYMMDDIIII', 'Occur year', 'Occur month', 'Occur day', 'Case idx', 'extended', 'region of terror', 'country', 'city', 'provstate', 'latitude', 'longitude', 'summary', 'multiple', 'success', 'suicide', 'attack type', 'target type', 'targsubtype', 'gname', 'motive', 'weapon type', 'weapon subtype', 'weapon detail', 'kill', 'wound', 'dbsource', 'ishostkid', 'ransom']);

    // find dict by some item value from array
    function findElement(arr, propName, propValue) {
        for (var i=0; i < arr.length; i++)
            if (arr[i][propName] == propValue)
                return arr[i];
    }
    let columnSelector = []
    let isFirstTime = true
    function drawTable(select_events){
        // Initialize
            columnSelector = total_keys.map(e=>false)

            // Mutable
            let select_keys = total_keys;

            // Load selected events data.
            let select_data =  [];
            for (let i=0; i < select_events.length; i++){
                select_data.push(findElement(json_data, 'eventid', select_events[i]))
            }
            if(isFirstTime){
                // Set up for DataTables
                let columnDef_list = [];
                for(let i=0; i < select_keys.length; i++){
                    let temp_dict = {};
                    temp_dict['targets'] = i;
                    temp_dict['data'] = select_keys[i];
                    temp_dict['width'] = column_widths[i] + 'px';
                    columnDef_list.push(temp_dict);
                    d3.select('#header-row')
                        .append('th')
                        .style('width', `${column_widths[i]}px !important`)
                        .attr('class', `text-center`)
                        .text(rename_keys(select_keys[i]));
                };
            
                let table = $("#gtd-table").DataTable({
                        data: select_data,
                        dom: 'Bfrti',
                        columns: columnDef_list,
                        buttons: [
                            'colvis'
                        ],
                        scrollX: true,
                        scrollY: 350, 
                        "scrollCollapse": true,
                        "paging":         false
                    });
                $('#gtd-table tbody')
                .on( 'mouseenter', 'td', function () {
                    var colIdx = table.cell(this).index().column;
                    // $( table.cells().nodes() ).removeClass( 'highlight' );
                    // highlight if not selected
                    if(!columnSelector[colIdx]){
                        $(table.column(colIdx).nodes()).addClass('highlight');
                    }
                    if(ctrlDown){
                        var rowIdx = table.row(this).index();
                        $(table.row(rowIdx).nodes()).addClass('highlight');
                    }
                });
                $('#gtd-table tbody')
                .on( 'mouseleave', 'td', function () {
                    var rowIdx = table.row(this).index();
                    $( table.row(rowIdx).nodes()).removeClass('highlight');
                
                    // highlight if not selected
                    var colIdx = table.cell(this).index().column;
                    if(!columnSelector[colIdx]){
                        $( table.column( colIdx ).nodes() ).removeClass( 'highlight' );
                    }
                });
    
                $('#gtd-table tbody').on( 'click', 'td', function () {
                    var colIdx = table.cell(this).index().column;
                    // list of selected columns
                    if(ctrlDown){
                        var eventId = table.row(this).index();
                        const selectedEventId = table.cell({ row: eventId, column: 0 }).data();
                        console.log('selectedEventId:', selectedEventId)
                    }else{
                        // select row only when ctrl is not pressed
                        columnSelector[colIdx] = !columnSelector[colIdx];
                    }
                    const listOfColumns = getColumnSelections(columnSelector, total_keys);
                    console.log('listOfColumns:', listOfColumns)
                });

                isFirstTime = false;
            }else{
                let table = $("#gtd-table").DataTable();
                // Load selected events data.
                let select_data =  [];
                for (let i=0; i < select_events.length; i++){
                    select_data.push(findElement(json_data, 'eventid', select_events[i]))
                }
                table.clear();
                table.rows.add(select_data);
                table.draw();
            }
        };
       function getColumnSelections(selections, total_keys){
           if(selections.legend!== total_keys.legend) return null;
           const listOfCols = []
           selections.forEach((e, i)=>{
               if(e){
                    listOfCols.push(total_keys[i])
               } 
           })
           return listOfCols;
       }
   
</script>

</body>

</html>
